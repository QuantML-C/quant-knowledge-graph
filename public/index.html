<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®ºæ–‡çŸ¥è¯†å›¾è°±å¯è§†åŒ–</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2196F3;
            --secondary-color: #FF9800;
            --bg-color: #f0f2f5;
            --panel-bg: rgba(255, 255, 255, 0.85);
            --text-color: #333;
            --border-radius: 16px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        body.dark {
            --bg-color: #121212;
            --panel-bg: rgba(30, 30, 30, 0.85);
            --text-color: #e0e0e0;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: flex;
        }

        /* Sidebar Styling */
        #sidebar {
            width: 380px;
            height: 100vh;
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: var(--box-shadow);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: absolute;
            left: 0;
            top: 0;
        }

        #sidebar.collapsed {
            transform: translateX(-380px);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h1 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar-section {
            margin-bottom: 25px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(0,0,0,0.03);
        }

        .sidebar-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #888;
            font-weight: 600;
        }

        /* Graph Area */
        #graph-area {
            flex: 1;
            position: relative;
            height: 100%;
            background: radial-gradient(circle at center, rgba(33, 150, 243, 0.03) 0%, rgba(0,0,0,0) 70%);
        }

        #graph {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* Toggle Sidebar Button */
        #toggle-sidebar {
            position: absolute;
            left: 380px;
            top: 20px;
            background: var(--panel-bg);
            border: none;
            padding: 10px;
            border-radius: 0 12px 12px 0;
            cursor: pointer;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            z-index: 999;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #sidebar.collapsed + #graph-area #toggle-sidebar {
            left: 0;
        }

        /* Search Input */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        #search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid transparent;
            border-radius: 12px;
            background: rgba(0,0,0,0.05);
            color: var(--text-color);
            font-size: 14px;
            box-sizing: border-box;
            transition: var(--transition);
        }

        #search-input:focus {
            outline: none;
            background: #fff;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.15);
        }
        
        body.dark #search-input:focus {
            background: #2c2c2c;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        /* Info Panel Content */
        .info-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .info-content.active {
            display: block;
        }

        .info-card {
            background: rgba(255,255,255,0.5);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary-color);
        }
        
        body.dark .info-card {
            background: rgba(255,255,255,0.05);
        }

        .tag-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .tag-chip {
            background: rgba(33, 150, 243, 0.1);
            color: var(--primary-color);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
        }

        .tag-chip:hover {
            background: var(--primary-color);
            color: #fff;
            transform: translateY(-2px);
        }

        /* Controls */
        .controls-overlay {
            position: absolute;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .control-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            color: var(--text-color);
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .control-btn:hover {
            transform: scale(1.1);
            background: #fff;
        }
        
        body.dark .control-btn:hover {
            background: #333;
        }

        /* Stats Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-item {
            background: rgba(0,0,0,0.03);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.75rem;
            color: #888;
        }

        /* Multi-tag Select */
        .multi-tag-area {
            background: rgba(0,0,0,0.02);
            padding: 10px;
            border-radius: 8px;
        }
        
        /* Node Styles */
        .node circle {
            transition: all 0.3s ease;
        }
        
        .node.dimmed {
            opacity: 0.1;
        }
        
        .link.dimmed {
            opacity: 0.05;
        }

        /* Tooltip */
        .graph-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 2000;
            backdrop-filter: blur(4px);
            max-width: 250px;
        }

        /* Loading */
        #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 3000;
            transition: opacity 0.5s;
        }
        
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid var(--primary-color);
            border-bottom-color: transparent;
            border-radius: 50%;
            animation: rotation 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loader"></div>
        <div style="font-weight: 500; color: var(--primary-color);">æ­£åœ¨æ„å»ºå›¾è°±...</div>
        </div>

    <div id="container">
        <!-- Sidebar -->
        <div id="sidebar">
            <div class="sidebar-header">
                <h1>ğŸ“š è®ºæ–‡çŸ¥è¯†å›¾è°±</h1>
                <div style="font-size: 12px; color: #666;">v1.2</div>
        </div>
        
            <div class="sidebar-content">
                
                <!-- Search Section -->
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="æœç´¢è®ºæ–‡ã€ä½œè€…æˆ–æ ‡ç­¾..." list="search-suggestions">
                    <span class="material-icons search-icon">search</span>
            <datalist id="search-suggestions"></datalist>
        </div>
        
                <!-- Default View: Stats & Filters -->
                <div id="default-panel" class="info-content active">
                    <div class="sidebar-section">
                        <h3>ğŸ“Š å›¾è°±ç»Ÿè®¡</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="stat-papers">0</div>
                                <div class="stat-label">è®ºæ–‡æ•°</div>
            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-tags">0</div>
                                <div class="stat-label">æ ‡ç­¾æ•°</div>
        </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-links">0</div>
                                <div class="stat-label">è¿æ¥æ•°</div>
            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-density">0</div>
                                <div class="stat-label">å¯†åº¦</div>
                            </div>
            </div>
        </div>
        
                    <div class="sidebar-section">
                        <h3>ğŸ› ï¸ è¿‡æ»¤å™¨</h3>
                        <div style="margin-bottom: 10px;">
                            <label style="display:flex; align-items:center; cursor:pointer; margin-bottom:8px;">
                                <input type="checkbox" id="toggle-papers" checked style="margin-right:8px;"> æ˜¾ç¤ºè®ºæ–‡èŠ‚ç‚¹
                            </label>
                            <label style="display:flex; align-items:center; cursor:pointer;">
                                <input type="checkbox" id="toggle-tags" checked style="margin-right:8px;"> æ˜¾ç¤ºæ ‡ç­¾èŠ‚ç‚¹
                            </label>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom: 10px;">
                            <span style="font-size:12px;">å¹´ä»½:</span>
                            <input type="number" id="year-min" class="filter-input" style="width:60px; padding:4px; border-radius:4px; border:1px solid #ddd;">
                            <span>-</span>
                            <input type="number" id="year-max" class="filter-input" style="width:60px; padding:4px; border-radius:4px; border:1px solid #ddd;">
                        </div>
                        <button id="btn-open-analysis" style="width:100%; padding:8px; background:var(--secondary-color); color:white; border:none; border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:bold; margin-top:10px;">
                            <span class="material-icons" style="font-size:16px; margin-right:5px;">analytics</span> æ·±åº¦åˆ†æå·¥å…·
                        </button>
                    </div>

                    <div class="sidebar-section">
                        <h3>ğŸ” å¤šæ ‡ç­¾æ£€ç´¢</h3>
                        <div class="multi-tag-area">
                            <div style="display:flex; gap:5px; margin-bottom:8px;">
                                <input type="text" id="multi-tag-input" list="multi-tag-suggestions" placeholder="è¾“å…¥æ ‡ç­¾..." style="flex:1; padding:6px; border-radius:4px; border:1px solid #ddd;">
                    <datalist id="multi-tag-suggestions"></datalist>
                                <button id="add-tag-btn" style="background:var(--primary-color); color:white; border:none; border-radius:4px; cursor:pointer;">+</button>
                </div>
                            <div id="selected-tags-container" class="tag-cloud"></div>
                            <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
                    <span id="multi-tag-result" style="font-size:12px; color:#666;"></span>
                                <div>
                                    <button id="find-multi-tag-btn" style="padding:4px 8px; background:var(--primary-color); color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;">æŸ¥æ‰¾</button>
                                    <button id="clear-multi-tag-btn" style="padding:4px 8px; background:#ddd; border:none; border-radius:4px; cursor:pointer; font-size:12px;">é‡ç½®</button>
                </div>
                            </div>
                            <div id="multi-tag-result-list" style="margin-top:10px; max-height:150px; overflow-y:auto;"></div>
                        </div>
            </div>
        </div>
        
                <!-- Analysis Panel -->
                <div id="analysis-panel" class="info-content">
                    <button id="back-to-stats-2" style="margin-bottom:15px; background:transparent; border:none; color:var(--primary-color); cursor:pointer; display:flex; align-items:center; font-weight:600;">
                        <span class="material-icons" style="font-size:16px; margin-right:5px;">arrow_back</span> è¿”å›æ¦‚è§ˆ
                    </button>
                    
                    <div class="sidebar-section">
                        <h3>ğŸ” æœ€çŸ­è·¯å¾„åˆ†æ</h3>
                        <div style="font-size:12px; color:#666; margin-bottom:10px;">é€‰æ‹©ä¸¤ä¸ªèŠ‚ç‚¹ä»¥å¯»æ‰¾å…³è”è·¯å¾„</div>
                        
                        <div style="margin-bottom:10px;">
                            <label style="font-size:12px; font-weight:bold;">èµ·ç‚¹:</label>
                            <div id="path-start-display" style="padding:8px; background:rgba(0,0,0,0.05); border-radius:4px; margin-top:4px; font-size:13px; color:#555;">æœªé€‰æ‹© (ç‚¹å‡»èŠ‚ç‚¹è®¾ç½®)</div>
                        </div>
                        
                        <div style="margin-bottom:15px;">
                            <label style="font-size:12px; font-weight:bold;">ç»ˆç‚¹:</label>
                            <div id="path-end-display" style="padding:8px; background:rgba(0,0,0,0.05); border-radius:4px; margin-top:4px; font-size:13px; color:#555;">æœªé€‰æ‹© (ç‚¹å‡»èŠ‚ç‚¹è®¾ç½®)</div>
                        </div>
                        
                        <div style="display:flex; gap:10px;">
                            <button id="btn-find-path" class="tag-chip" style="flex:1; text-align:center; background:var(--primary-color); color:white;">å¼€å§‹åˆ†æ</button>
                            <button id="btn-clear-path" class="tag-chip" style="background:#ddd; color:#333;">æ¸…é™¤</button>
                        </div>
                        
                        <div id="path-result" style="margin-top:15px; font-size:13px; line-height:1.6;"></div>
                    </div>
                    
                    <div class="sidebar-section">
                        <h3>ğŸ’¾ æ•°æ®ç®¡ç†</h3>
                        <button id="btn-export-csv" class="tag-chip" style="width:100%; text-align:center; margin-bottom:10px;">å¯¼å‡ºå½“å‰æ•°æ® (CSV)</button>
                    </div>
                </div>

                <!-- Details View: Selected Node Info -->
                <div id="details-panel" class="info-content">
                    <button id="back-to-stats" style="margin-bottom:15px; background:transparent; border:none; color:var(--primary-color); cursor:pointer; display:flex; align-items:center; font-weight:600;">
                        <span class="material-icons" style="font-size:16px; margin-right:5px;">arrow_back</span> è¿”å›æ¦‚è§ˆ
                    </button>
                    
                    <div id="node-details">
                        <!-- Dynamic Content Here -->
        </div>

                    <div class="sidebar-section" style="margin-top:20px;">
                        <h3>æ“ä½œ</h3>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <button id="btn-focus-node" class="tag-chip" style="background:#4CAF50; color:white;">ğŸ‘ï¸ èšç„¦æ¨¡å¼</button>
                            <button id="btn-pin-node" class="tag-chip" style="background:#FF9800; color:white;">ğŸ“ é”å®šä½ç½®</button>
                        </div>
                        <div style="margin-top:10px;">
                            <button onclick="setPathStart(state.currentNode)" class="tag-chip" style="background:#2196F3; color:white;">ğŸ è®¾ä¸ºè·¯å¾„èµ·ç‚¹</button>
                            <button onclick="setPathEnd(state.currentNode)" class="tag-chip" style="background:#9C27B0; color:white;">ğŸš© è®¾ä¸ºè·¯å¾„ç»ˆç‚¹</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Sidebar Toggle -->
        <button id="toggle-sidebar" title="åˆ‡æ¢ä¾§è¾¹æ ">
            <span class="material-icons">menu_open</span>
        </button>

        <!-- Graph Visualization -->
        <div id="graph-area">
            <div id="graph"></div>
        
        <div class="tooltip" id="node-tooltip"></div>
            
            <div class="controls-overlay">
                <button class="control-btn" id="zoom-in" title="æ”¾å¤§"><span class="material-icons">add</span></button>
                <button class="control-btn" id="zoom-out" title="ç¼©å°"><span class="material-icons">remove</span></button>
                <button class="control-btn" id="fit-view" title="é€‚é…å…¨å›¾"><span class="material-icons">center_focus_strong</span></button>
                <button class="control-btn" id="toggle-focus-mode" title="å…¨å±€èšç„¦æ¨¡å¼ (æ˜¾ç¤ºé€‰ä¸­èŠ‚ç‚¹åŠé‚»å±…)"><span class="material-icons">filter_center_focus</span></button>
                <button class="control-btn" id="cluster-color" title="æŒ‰ç¤¾åŒºç€è‰²"><span class="material-icons">palette</span></button>
                <button class="control-btn" id="export-png" title="å¯¼å‡ºå›¾ç‰‡"><span class="material-icons">download</span></button>
                <button class="control-btn" id="toggle-dark" title="åˆ‡æ¢ä¸»é¢˜"><span class="material-icons">dark_mode</span></button>
            </div>

            <!-- Legend -->
            <div style="position:absolute; bottom:30px; left:30px; background:var(--panel-bg); padding:10px; border-radius:8px; backdrop-filter:blur(5px); box-shadow:0 2px 10px rgba(0,0,0,0.1);">
                <div style="display:flex; align-items:center; margin-bottom:5px;">
                    <span style="width:12px; height:12px; background:#ff7f0e; border-radius:50%; margin-right:8px;"></span>
                    <span style="font-size:12px;">è®ºæ–‡</span>
                </div>
                <div style="display:flex; align-items:center;">
                    <span style="width:12px; height:12px; background:#1f77b4; border-radius:50%; margin-right:8px;"></span>
                    <span style="font-size:12px;">æ ‡ç­¾</span>
                </div>
            </div>
            
             <div class="nav-links" style="position:absolute; top:20px; right:20px; display:flex; gap:10px;">
                <a href="tag-graph.html" style="background:white; padding:8px 15px; border-radius:20px; text-decoration:none; color:#333; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1); font-size:13px;">â†’ æ ‡ç­¾å…³ç³»å›¾è°±</a>
                <a href="3d-graph.html" style="background:#2c3e50; padding:8px 15px; border-radius:20px; text-decoration:none; color:white; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1); font-size:13px;">ğŸŒŒ 3D è§†å›¾</a>
            </div>
        </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-polygon@3"></script>
    <script>
        // --- State Management ---
        const state = {
            nodes: [],
            links: [],
            width: window.innerWidth,
            height: window.innerHeight,
            transform: d3.zoomIdentity,
            currentNode: null,
            focusMode: false,
            colorByCluster: false,
            showHulls: false,
            clusterColors: d3.scaleOrdinal(d3.schemeCategory10),
            filters: {
                showPapers: true,
                showTags: true,
                minYear: null,
                maxYear: null
            },
            multiTags: new Set(),
            pathStart: null,
            pathEnd: null
        };

        // --- D3 Variables ---
        let svg, g, simulation, link, node, hullPath, zoom;

        // --- DOM Elements ---
        const els = {
            sidebar: document.getElementById('sidebar'),
            toggleBtn: document.getElementById('toggle-sidebar'),
            defaultPanel: document.getElementById('default-panel'),
            detailsPanel: document.getElementById('details-panel'),
            analysisPanel: document.getElementById('analysis-panel'),
            nodeDetails: document.getElementById('node-details'),
            searchInput: document.getElementById('search-input'),
            tooltip: document.getElementById('node-tooltip'),
            loading: document.getElementById('loading-screen'),
            toast: document.getElementById('toast-container')
        };
        
        // --- Toast System ---
        function showToast(msg, type='info') {
            if(!els.toast) {
                const div = document.createElement('div');
                div.id = 'toast-container';
                div.style.cssText = 'position:fixed; bottom:30px; left:50%; transform:translateX(-50%); z-index:9999; display:flex; flex-direction:column; gap:10px; pointer-events:none;';
                document.body.appendChild(div);
                els.toast = div;
            }
            const el = document.createElement('div');
            el.style.cssText = `
                background: ${type === 'error' ? '#f44336' : '#333'};
                color: white; padding: 10px 20px; border-radius: 8px; 
                box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
                font-size: 14px; opacity: 0; transform: translateY(20px); transition: all 0.3s;
            `;
            el.textContent = msg;
            els.toast.appendChild(el);
            requestAnimationFrame(() => { el.style.opacity = '1'; el.style.transform = 'translateY(0)'; });
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(20px)';
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        // --- Initialization ---
        async function init() {
            try {
                // Setup Layout
                setupUI();
                
                // Load Data
                const response = await fetch('papers.json');
                const papers = await response.json();
                processData(papers);
                
                // Initialize Graph
                initGraph();
                
                // Finalize
                updateStats();
                els.loading.style.opacity = 0;
                setTimeout(() => els.loading.style.display = 'none', 500);
                
            } catch (error) {
                console.error("Initialization failed:", error);
                els.loading.innerHTML = `<p style="color:red">Error: ${error.message}</p>`;
            }
        }

        // --- Data Processing ---
        function processData(papers) {
            const tagSet = new Set();
            const yearList = [];

            // Extract Tags and Years
            papers.forEach(p => {
                if (p.tags) p.tags.forEach(t => tagSet.add(t));
                if (p.year) yearList.push(p.year);
            });

            // Create Nodes
            state.nodes = papers.map(p => ({
                id: p.id,
                name: p.title,
                        type: 'paper',
                data: p,
                r: 8
            }));

            tagSet.forEach(t => {
                state.nodes.push({
                    id: `tag-${t}`,
                    name: t,
                        type: 'tag',
                    data: { tag: t },
                    r: 5
                    });
                });
                
            // Create Links
            papers.forEach(p => {
                if (p.tags) {
                    p.tags.forEach(t => {
                        state.links.push({
                            source: p.id,
                            target: `tag-${t}`,
                                value: 1
                            });
                        });
                    }
                });
                
            // Calculate Tag Weights (Degree)
            const tagCounts = {};
            state.links.forEach(l => {
                const tagId = l.target; // Since we pushed links as paper->tag
                tagCounts[tagId] = (tagCounts[tagId] || 0) + 1;
            });
            
            state.nodes.forEach(n => {
                if (n.type === 'tag') {
                    n.r = Math.max(5, Math.min(20, 5 + (tagCounts[n.id] || 0) / 2));
                }
            });

            // Set Filter Range
            if (yearList.length) {
                state.filters.minYear = Math.min(...yearList);
                state.filters.maxYear = Math.max(...yearList);
                document.getElementById('year-min').value = state.filters.minYear;
                document.getElementById('year-max').value = state.filters.maxYear;
            }

            // Populate Search Suggestions
            const dl = document.getElementById('search-suggestions');
            const multiDl = document.getElementById('multi-tag-suggestions');
            state.nodes.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n.name;
                dl.appendChild(opt);
                
                if (n.type === 'tag') {
                    const mOpt = document.createElement('option');
                    mOpt.value = n.name;
                    multiDl.appendChild(mOpt);
                }
            });
            
            // Calculate Communities (Simple Connected Components or Modularity approximation if feasible)
            // For now, we will assign a "random" community based on primary tag for papers, or keep default colors
        }

        // --- Graph Rendering ---
        function initGraph() {
            const width = els.sidebar.classList.contains('collapsed') ? window.innerWidth : window.innerWidth - 380;
            const height = window.innerHeight;

            svg = d3.select("#graph")
                .append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .on("click", handleBackgroundClick);

            g = svg.append("g");

            zoom = d3.zoom()
                .scaleExtent([0.1, 8])
                .on("zoom", e => g.attr("transform", e.transform));
            
            svg.call(zoom);
            
            simulation = d3.forceSimulation(state.nodes)
                .force("link", d3.forceLink(state.links).id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collide", d3.forceCollide().radius(d => d.r + 5).iterations(2));
            
            link = g.append("g")
                .selectAll("line")
                .data(state.links)
                .join("line")
                .attr("stroke", "#999")
                .attr("stroke-opacity", 0.6)
                .attr("stroke-width", 1);

            node = g.append("g")
                .selectAll(".node")
                .data(state.nodes)
                .join("g")
                .attr("class", "node")
                .call(d3.drag()
                    .on("start", dragStart)
                    .on("drag", dragging)
                    .on("end", dragEnd))
                .on("click", handleNodeClick)
                .on("mouseover", showTooltip)
                .on("mouseout", hideTooltip);
            
            node.append("circle")
                .attr("r", d => d.r)
                .attr("fill", d => d.type === 'paper' ? '#ff7f0e' : '#1f77b4')
                .attr("stroke", "#fff")
                .attr("stroke-width", 1.5);
            
            node.append("text")
                .text(d => d.type === 'tag' ? (d.name.length > 10 ? d.name.slice(0,10)+'...' : d.name) : '')
                .attr("font-size", 10)
                .attr("dx", 12)
                .attr("dy", 4)
                .attr("fill", "#666")
                .style("pointer-events", "none")
                .style("display", d => d.r > 8 ? "block" : "none");

            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("transform", d => `translate(${d.x},${d.y})`);
                    
                if(state.showHulls) updateHulls();
            });
            
            // Initial positioning helper
            // setTimeout(() => simulation.stop(), 5000); 
        }

        // --- Interaction Handlers ---
        
        function handleNodeClick(event, d) {
            event.stopPropagation();
            state.currentNode = d;
            
            // Highlight Visuals
            node.classed("dimmed", true);
            link.classed("dimmed", true);
            
            // Get Neighbors
            const connectedIds = new Set([d.id]);
            link.each(l => {
                if (l.source.id === d.id) connectedIds.add(l.target.id);
                if (l.target.id === d.id) connectedIds.add(l.source.id);
            });
            
            // Restore opacity for self and neighbors
            node.filter(n => connectedIds.has(n.id))
                .classed("dimmed", false)
                .select("circle")
                .attr("stroke", "#000")
                .attr("stroke-width", 2);
                
            link.filter(l => connectedIds.has(l.source.id) && connectedIds.has(l.target.id))
                .classed("dimmed", false)
                .attr("stroke-opacity", 1);
            
            // Update Sidebar
            showNodeDetails(d);
            
            // Focus Camera
            const scale = 2;
            svg.transition().duration(750).call(
                zoom.transform, 
                d3.zoomIdentity.translate(state.width/2 - d.x*scale, state.height/2 - d.y*scale).scale(scale)
            );
        }

        function handleBackgroundClick(event) {
            if (event.target.tagName === 'svg') {
                resetView();
            }
        }

        function resetView() {
            state.currentNode = null;
            node.classed("dimmed", false);
            link.classed("dimmed", false);
            node.select("circle").attr("stroke", "#fff").attr("stroke-width", 1.5);
            link.attr("stroke-opacity", 0.6);
            
            // If in focus mode, we might want to stay in focus mode? 
            // For now, clicking background resets selection.
            if(state.focusMode) toggleFocusMode(); // Turn off focus mode if active

            els.defaultPanel.classList.add('active');
            els.detailsPanel.classList.remove('active');
        }

        function showNodeDetails(d) {
            els.defaultPanel.classList.remove('active');
            els.detailsPanel.classList.add('active');
            
            let html = '';
            if (d.type === 'paper') {
                html = `
                    <div class="info-card">
                        <h2 style="margin:0 0 10px 0; font-size:1.1rem; color:var(--primary-color);">${d.name}</h2>
                        <div style="font-size:0.9rem; color:#666; margin-bottom:5px;">
                            <strong>ä½œè€…:</strong> ${d.data.authors ? d.data.authors.join(', ') : 'Unknown'}
                        </div>
                        <div style="font-size:0.9rem; color:#666; margin-bottom:5px;">
                            <strong>å¹´ä»½:</strong> ${d.data.year || 'N/A'}
                        </div>
                    </div>
                    <div class="sidebar-section">
                        <h3>æ‘˜è¦</h3>
                        <p style="font-size:0.9rem; line-height:1.5; color:#444;">${d.data.abstract || 'æ— æ‘˜è¦'}</p>
                    </div>
                    <div class="sidebar-section">
                        <h3>æ ‡ç­¾</h3>
                        <div class="tag-cloud">
                            ${(d.data.tags||[]).map(t => `<span class="tag-chip" onclick="findNodeByName('${t}')">${t}</span>`).join('')}
                        </div>
                    </div>
                `;
            } else {
                // Tag Info
                 const relatedPapers = state.nodes
                    .filter(n => n.type === 'paper' && n.data.tags && n.data.tags.includes(d.name))
                    .slice(0, 120); // cap to avoid huge DOM
                 html = `
                    <div class="info-card" style="border-left-color: #1f77b4;">
                        <h2 style="margin:0 0 10px 0; font-size:1.1rem;">æ ‡ç­¾: ${d.name}</h2>
                        <div style="font-size:0.9rem; color:#666;">
                            å…³è”è®ºæ–‡æ•°: ${relatedPapers.length}
                        </div>
                    </div>
                    <div class="sidebar-section">
                        <h3>ç›¸å…³è®ºæ–‡</h3>
                        <div style="max-height:240px; overflow:auto;">
                            ${
                                relatedPapers.length
                                ? relatedPapers.map(p => `
                                    <div class="paper-link" style="margin-bottom:6px;" onclick="focusNodeById('${p.id}')">
                                        <div style="font-weight:600; color:#333;">${p.data.title}</div>
                                        <div style="font-size:12px; color:#777;">${p.data.year || 'N/A'} Â· ${(p.data.authors||[])[0] || 'æœªçŸ¥ä½œè€…'}</div>
                                    </div>
                                `).join('')
                                : '<div style="color:#888;">æš‚æ— å…³è”è®ºæ–‡</div>'
                            }
                        </div>
                    </div>
                `;
            }
            els.nodeDetails.innerHTML = html;
        }

        // --- Features ---
        
        function toggleFocusMode() {
            state.focusMode = !state.focusMode;
            const btn = document.getElementById('toggle-focus-mode');
            btn.style.background = state.focusMode ? 'var(--primary-color)' : 'var(--panel-bg)';
            btn.style.color = state.focusMode ? '#fff' : 'var(--text-color)';
            
            if (state.focusMode && state.currentNode) {
                // Keep only neighbors visible
                const connectedIds = new Set([state.currentNode.id]);
                link.each(l => {
                    if (l.source.id === state.currentNode.id) connectedIds.add(l.target.id);
                    if (l.target.id === state.currentNode.id) connectedIds.add(l.source.id);
                });
                
                node.style("display", n => connectedIds.has(n.id) ? "block" : "none");
                link.style("display", l => connectedIds.has(l.source.id) && connectedIds.has(l.target.id) ? "block" : "none");
                } else {
                // Show all (respecting filters)
                applyFilters();
            }
        }
        
        // --- Helpers ---
        function findNodeByName(name) {
            const target = state.nodes.find(n => n.name === name || n.id === `tag-${name}`);
            if (target) {
                 handleNodeClick({stopPropagation:()=>{}}, target);
            }
        }
        // ä¸“ç”¨ï¼šé€šè¿‡èŠ‚ç‚¹ ID èšç„¦ï¼ˆç”¨äºåˆ—è¡¨ç‚¹å‡»ï¼‰
        function focusNodeById(id) {
            const target = state.nodes.find(n => n.id === id);
            if (target) {
                handleNodeClick({stopPropagation:()=>{}}, target);
            }
        }
        
        // --- Setup UI Handlers ---
        function setupUI() {
            // Sidebar Toggle
            els.toggleBtn.addEventListener('click', () => {
                els.sidebar.classList.toggle('collapsed');
                els.toggleBtn.querySelector('span').textContent = els.sidebar.classList.contains('collapsed') ? 'menu' : 'menu_open';
            });
            
            // Back button
            document.getElementById('back-to-stats').addEventListener('click', resetView);
            
            // Search
            els.searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                if (!term) {
                    node.classed("dimmed", false);
                    return;
                }
                const matches = state.nodes.filter(n => n.name.toLowerCase().includes(term));
                const matchIds = new Set(matches.map(n => n.id));
                
                node.classed("dimmed", n => !matchIds.has(n.id));
                if(matches.length === 1) {
                   // focusOnNode(matches[0]); // Optional: auto focus
                }
            });
            
            // Filters
            document.getElementById('toggle-papers').addEventListener('change', applyFilters);
            document.getElementById('toggle-tags').addEventListener('change', applyFilters);
            document.getElementById('year-min').addEventListener('change', applyFilters);
            document.getElementById('year-max').addEventListener('change', applyFilters);
            
            // Controls
            document.getElementById('zoom-in').addEventListener('click', () => svg.transition().call(zoom.scaleBy, 1.2));
            document.getElementById('zoom-out').addEventListener('click', () => svg.transition().call(zoom.scaleBy, 0.8));
            document.getElementById('fit-view').addEventListener('click', fitView);
            document.getElementById('toggle-focus-mode').addEventListener('click', toggleFocusMode);
            document.getElementById('btn-focus-node').addEventListener('click', toggleFocusMode);
            document.getElementById('toggle-dark').addEventListener('click', () => {
                document.body.classList.toggle('dark');
                localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
            });
            document.getElementById('export-png').addEventListener('click', exportPNG);
            
            // New UI Handlers
            document.getElementById('btn-open-analysis').addEventListener('click', () => {
                els.defaultPanel.classList.remove('active');
                els.analysisPanel.classList.add('active');
            });
            document.getElementById('back-to-stats-2').addEventListener('click', () => {
                els.analysisPanel.classList.remove('active');
                els.defaultPanel.classList.add('active');
            });
            
            document.getElementById('btn-pin-node').addEventListener('click', () => {
                if(state.currentNode) {
                    if(state.currentNode.fx) {
                        state.currentNode.fx = null;
                        state.currentNode.fy = null;
                        showToast("å·²è§£é”ä½ç½®");
                    } else {
                        state.currentNode.fx = state.currentNode.x;
                        state.currentNode.fy = state.currentNode.y;
                        showToast("å·²é”å®šä½ç½®");
                    }
                }
            });
            
            // Pathfinding UI
            document.getElementById('btn-find-path').addEventListener('click', runPathfinding);
            document.getElementById('btn-clear-path').addEventListener('click', clearPath);
            document.getElementById('btn-export-csv').addEventListener('click', exportCSV);

            // Community/Cluster Color
            document.getElementById('cluster-color').addEventListener('click', () => {
                state.colorByCluster = !state.colorByCluster;
                state.showHulls = state.colorByCluster; // Toggle hulls with color
                
                if(state.colorByCluster) {
                    detectCommunities();
                    node.select("circle").attr("fill", d => state.clusterColors(d.community));
                    updateHulls();
                    showToast("å·²å¯ç”¨ç¤¾åŒºç€è‰²ä¸è½®å»“");
                } else {
                    node.select("circle").attr("fill", d => d.type === 'paper' ? '#ff7f0e' : '#1f77b4');
                    g.selectAll(".hull").remove();
                    showToast("å·²æ¢å¤é»˜è®¤ç€è‰²");
                }
            });

            // Initialize Theme
            if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');
            
            // Resize
            window.addEventListener('resize', () => {
                state.width = window.innerWidth;
                state.height = window.innerHeight;
                svg.attr("width", "100%").attr("height", "100%");
                simulation.force("center", d3.forceCenter(state.width/2, state.height/2)).restart();
            });
            
            // Multi-tag setup
            setupMultiTags();
        }

        function setupMultiTags() {
            const btn = document.getElementById('add-tag-btn');
            const input = document.getElementById('multi-tag-input');
            const container = document.getElementById('selected-tags-container');
            
            const add = () => {
                const val = input.value.trim();
                if(val && !state.multiTags.has(val)) {
                    state.multiTags.add(val);
                    renderTags();
                    input.value = '';
                }
            };
            
            const renderTags = () => {
                container.innerHTML = '';
                state.multiTags.forEach(t => {
                    const el = document.createElement('span');
                    el.className = 'tag-chip';
                    el.textContent = t + ' Ã—';
                    el.onclick = () => { state.multiTags.delete(t); renderTags(); };
                    container.appendChild(el);
                });
            };
            
            btn.onclick = add;
            input.onkeydown = e => e.key === 'Enter' && add();
            
            document.getElementById('find-multi-tag-btn').onclick = () => {
                if(state.multiTags.size === 0) return;
                const tags = Array.from(state.multiTags);
                const papers = state.nodes.filter(n => n.type === 'paper' && tags.every(t => n.data.tags && n.data.tags.includes(t)));
                
                document.getElementById('multi-tag-result').textContent = `æ‰¾åˆ° ${papers.length} ç¯‡`;
                const list = document.getElementById('multi-tag-result-list');
                list.innerHTML = papers.map(p => `<div style="padding:5px; border-bottom:1px solid #eee; cursor:pointer;" onclick="findNodeByName('${p.name}')">${p.name}</div>`).join('');
                
                // Highlight
                const ids = new Set(papers.map(p => p.id));
                node.classed("dimmed", n => !ids.has(n.id));
            };
            
            document.getElementById('clear-multi-tag-btn').onclick = () => {
                state.multiTags.clear();
                renderTags();
                document.getElementById('multi-tag-result').textContent = '';
                document.getElementById('multi-tag-result-list').innerHTML = '';
                resetView();
            };
        }

        function updateStats() {
            const paperCount = state.nodes.filter(n => n.type === 'paper').length;
            const tagCount = state.nodes.filter(n => n.type === 'tag').length;
            const linkCount = state.links.length;
            // Density = 2 * E / (V * (V-1))
            const v = state.nodes.length;
            const density = v > 1 ? (2 * linkCount / (v * (v - 1))).toFixed(4) : 0;

            document.getElementById('stat-papers').textContent = paperCount;
            document.getElementById('stat-tags').textContent = tagCount;
            document.getElementById('stat-links').textContent = linkCount;
            document.getElementById('stat-density').textContent = density;
        }

        function applyFilters() {
            const showP = document.getElementById('toggle-papers').checked;
            const showT = document.getElementById('toggle-tags').checked;
            const minY = parseInt(document.getElementById('year-min').value) || 0;
            const maxY = parseInt(document.getElementById('year-max').value) || 9999;
            
            node.style("display", d => {
                if (d.type === 'paper') {
                    const y = d.data.year || 0;
                    return (showP && y >= minY && y <= maxY) ? "block" : "none";
                }
                return showT ? "block" : "none";
            });
            
            // Re-check links visibility based on node visibility
            // (Simple implementation: link is visible if both ends are visible)
            // But we can't easily query display property efficiently in loop. 
            // Better to update classes.
            // For now, let D3 handle display updates on tick or filter re-run.
            // Actually, we should update opacity or display.
             link.style("display", function(d) {
                // We need to check the visibility of source and target
                // Accessing the style of the node element is slow.
                // Let's use logic.
                const sourceVisible = (d.source.type === 'tag' ? showT : (showP && (d.source.data.year||0) >= minY && (d.source.data.year||0) <= maxY));
                const targetVisible = (d.target.type === 'tag' ? showT : (showP && (d.target.data.year||0) >= minY && (d.target.data.year||0) <= maxY));
                return (sourceVisible && targetVisible) ? "block" : "none";
            });
        }
        
        // --- Community Detection (Louvain-ish / Simple Label Propagation) ---
        function detectCommunities() {
            // Very simple propagation: Assign each paper to its "rarest" tag or just a random tag
            // Or better: Iterate a few times taking majority label of neighbors
            
            // Initialize: Each node is its own community
            state.nodes.forEach((n, i) => n.community = i);
            
            // Simple propagation (1 pass)
            state.nodes.forEach(n => {
                const neighbors = [];
                state.links.forEach(l => {
                    if(l.source.id === n.id) neighbors.push(l.target);
                    if(l.target.id === n.id) neighbors.push(l.source);
                });
                
                if(neighbors.length > 0) {
                     // Find most frequent community among neighbors
                     const counts = {};
                     neighbors.forEach(nbr => {
                         const c = nbr.community;
                         counts[c] = (counts[c] || 0) + 1;
                     });
                     let maxC = n.community, maxCount = -1;
                     for(let c in counts) {
                         if(counts[c] > maxCount) {
                             maxCount = counts[c];
                             maxC = c;
                         }
                     }
                     n.community = maxC;
                }
            });
        }

        // --- Pathfinding & Hulls ---
        
        function setPathStart(node) {
            state.pathStart = node;
            document.getElementById('path-start-display').textContent = node.name;
            showToast(`å·²è®¾ç½®èµ·ç‚¹: ${node.name}`);
        }
        function setPathEnd(node) {
            state.pathEnd = node;
            document.getElementById('path-end-display').textContent = node.name;
            showToast(`å·²è®¾ç½®ç»ˆç‚¹: ${node.name}`);
        }
        
        function runPathfinding() {
            if(!state.pathStart || !state.pathEnd) {
                showToast("è¯·å…ˆé€‰æ‹©èµ·ç‚¹å’Œç»ˆç‚¹", "error");
                return;
            }
            
            // BFS
            const queue = [[state.pathStart]];
            const visited = new Set([state.pathStart.id]);
            let foundPath = null;
            
            while(queue.length > 0) {
                const path = queue.shift();
                const current = path[path.length - 1];
                
                if(current.id === state.pathEnd.id) {
                    foundPath = path;
                    break;
                }
                
                // Find neighbors
                const neighbors = [];
                state.links.forEach(l => {
                    if(l.source.id === current.id) neighbors.push(l.target);
                    if(l.target.id === current.id) neighbors.push(l.source);
                });
                
                for(let neighbor of neighbors) {
                    if(!visited.has(neighbor.id)) {
                        visited.add(neighbor.id);
                        queue.push([...path, neighbor]);
                    }
                }
            }
            
            if(foundPath) {
                const pathIds = new Set(foundPath.map(n => n.id));
                // Highlight
                node.classed("dimmed", n => !pathIds.has(n.id));
                link.classed("dimmed", l => !(pathIds.has(l.source.id) && pathIds.has(l.target.id)));
                
                // Draw line path explicitly
                const resultDiv = document.getElementById('path-result');
                resultDiv.innerHTML = `<strong>å‘ç°è·¯å¾„ (é•¿åº¦ ${foundPath.length}):</strong><br>` + 
                    foundPath.map(n => `<span class="tag-chip" onclick="findNodeByName('${n.name}')" style="margin:2px; display:inline-block;">${n.name}</span>`).join(' â†’ ');
                
                showToast("è·¯å¾„åˆ†æå®Œæˆ");
            } else {
                showToast("æœªæ‰¾åˆ°å…³è”è·¯å¾„", "error");
                document.getElementById('path-result').textContent = "æ— å…³è”è·¯å¾„";
            }
        }
        
        function clearPath() {
            state.pathStart = null;
            state.pathEnd = null;
            document.getElementById('path-start-display').textContent = "æœªé€‰æ‹©";
            document.getElementById('path-end-display').textContent = "æœªé€‰æ‹©";
            document.getElementById('path-result').textContent = "";
            resetView();
        }

        function updateHulls() {
            if(!state.colorByCluster) return;
            
            const groups = d3.group(state.nodes, d => d.community);
            const hulls = [];
            
            for(let [key, members] of groups) {
                // We need points.
                // Hull requires at least 3 points.
                if(members.length < 3) continue;
                const points = members.map(d => [d.x, d.y]);
                const hull = d3.polygonHull(points);
                if(hull) hulls.push({ id: key, path: hull });
            }
            
            g.selectAll(".hull")
                .data(hulls)
                .join("path")
                .attr("class", "hull")
                .attr("d", d => "M" + d.path.join("L") + "Z")
                .attr("fill", d => state.clusterColors(d.id))
                .attr("fill-opacity", 0.1)
                .attr("stroke", d => state.clusterColors(d.id))
                .attr("stroke-width", 20)
                .attr("stroke-linejoin", "round")
                .attr("stroke-opacity", 0.1)
                .style("pointer-events", "none") // Let clicks pass through
                .lower(); // Send to back
        }
        
        function exportCSV() {
            const rows = [["Title", "Year", "Authors", "Tags", "Abstract"]];
            // Filtered nodes
            const visibleNodes = state.nodes.filter(n => n.type === 'paper' && (!state.filters.minYear || n.data.year >= state.filters.minYear));
            
            visibleNodes.forEach(n => {
                rows.push([
                    `"${(n.data.title || '').replace(/"/g, '""')}"`,
                    n.data.year || '',
                    `"${(n.data.authors || []).join(', ')}"`,
                    `"${(n.data.tags || []).join('; ')}"`,
                    `"${(n.data.abstract || '').replace(/"/g, '""')}"`
                ]);
            });
            
            const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "papers_export.csv");
            document.body.appendChild(link);
            link.click();
            link.remove();
            showToast("CSV å¯¼å‡ºæˆåŠŸ");
        }

        function fitView() {
            const bounds = g.node().getBBox();
            const parent = svg.node().parentElement;
            const fullWidth = parent.clientWidth;
            const fullHeight = parent.clientHeight;
            const width = bounds.width;
            const height = bounds.height;
            const midX = bounds.x + width / 2;
            const midY = bounds.y + height / 2;
            if (width == 0 || height == 0) return;
            const scale = 0.85 / Math.max(width / fullWidth, height / fullHeight);
            const translate = [fullWidth / 2 - scale * midX, fullHeight / 2 - scale * midY];

            svg.transition().duration(750)
                .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
        }
        
        function dragStart(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragging(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragEnd(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
        
        function showTooltip(event, d) {
            els.tooltip.style.opacity = 1;
            els.tooltip.style.left = (event.pageX + 10) + 'px';
            els.tooltip.style.top = (event.pageY - 20) + 'px';
            els.tooltip.textContent = d.name;
        }
        
        function hideTooltip() {
            els.tooltip.style.opacity = 0;
        }

        function exportPNG() {
            const svgNode = svg.node();
            const serializer = new XMLSerializer();
            let source = serializer.serializeToString(svgNode);
            if (!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)) {
                source = source.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
            }
            source = '<?xml version="1.0" standalone="no"?>\r\n' + source;
            const url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);
            const image = new Image();
            image.onload = function() {
                const canvas = document.createElement('canvas');
                canvas.width = state.width;
                canvas.height = state.height;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = document.body.classList.contains('dark') ? '#121212' : '#f0f2f5';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(image, 0, 0);
                const a = document.createElement('a');
                a.download = 'graph.png';
                a.href = canvas.toDataURL('image/png');
                a.click();
            };
            image.src = url;
        }
        
        // Boot
        init();

    </script>
</body>
</html> 